#! /usr/bin/env node

const commander = require('commander');
const ora = require('ora');
const chalk = require('../lib/chalk');
const download = require('../lib/download');
const spinner = ora();
const { checkHttps, to, checkFile, rmFile, mkDir } = require('../utils/tool');
const reptile = require('../lib/reptile');

commander
  .version(require('../package.json').version, '-v, --version')
  .description(
    `
    下载iconfont专用工具
    ---------
    icon-cli source 在当前运行目录下替换iconfont文件
    使用文档：https://songzhaopian.com
    `
  )
  .helpOption('-h, --help')
  .action(({}, source) => {
    if (source.length > 1) {
      spinner.warn(chalk.red('非法入参, 只接受一个资源地址'))
      spinner.stop();
      return ;
    }
    const url = checkHttps(source[0]);
    if (httpsVerify(url)) return;
    __download(url);
  })
  .command('target')
  .description('icon-cli target 文件目录位置,相对路径 网络资源地址')
  .action(async ({}, source) => {
    if (source.length !== 2) {
      spinner.warn(chalk.red('非法入参, 你需要传入两个参数'))
      spinner.stop();
      return;
    }
    const path = source[0].replace(/\/{1,}$/ig, '');
    const url = checkHttps(source[1]);
    if (httpsVerify(url)) return;
    const [err] = await to(mkDir(path));
    if (err) {
      spinner.fail(chalk.red('文件目录创建失败'))
      spinner.stop();
      return;
    }
    __download(url, path);
  });

commander
  .command('init')
  .description('icon-cli init 初始化下载配置,请在项目更目录下初始化')
  .action((args) => {
    console.log('init 操作', args)
  })

commander
  .command('d')
  .description('icon-cli d 依据下载配置,下载相关字体资源')
  .action(() => {
    // TODO: 先设计好配置项
    const config = {
      target: './lib/iconfont',
      url: 'https://www.iconfont.cn/manage/index?spm=a313x.7781069.1998910419.db775f1f3&manage_type=myprojects&projectId=738291&keyword=',
    }
    reptile(config.url);
    // https.get(config.url, (res) => {
    //   res.on('data', (data) => {
    //     console.log(data);
    //   });
    //   res.on('end', () => {
    //     console.info('https-end')
    //   })
    // })
    console.log('d 下载操作', config);
  })

commander.parse(process.argv);

function httpsVerify(url) {
  if (!url) {
    spinner.warn(chalk.red('非法入参, 请确保是正确的 https://xxxxx 资源地址'))
    spinner.stop();
    return true;
  }
  return false;
}

async function __download(url, path) {
  const [err] = await to(checkFile('iconfont.js'));
  if (err) {
    downloadHandle(url, path);
    return;
  }
  const [, result] = await to(rmFile('iconfont.js'));
  result && downloadHandle(url, path);
}

async function downloadHandle(url, path) {
  spinner.start(chalk.green('下载中... 请稍后'));
  const [err, successful] = await to(download(url, path));
  if (err) {
    spinner.fail(chalk.redBright(`文件保存失败\n${err}`));
    spinner.stop();
    return;
  }
  spinner.succeed(chalk.green(successful));
  spinner.stop();
}
